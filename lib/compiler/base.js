var base = require('handlebars/lib/handlebars/compiler/base');

/**
 * Attach the base compiler functionality to the DOMBars object.
 *
 * @param  {Object} DOMBars
 * @return {Object}
 */
exports.attach = function (DOMBars) {
  base.attach(DOMBars);

  // Extend the DOMBars root object with an event emitter.
  DOMBars.Utils.extend(DOMBars, require('events').EventEmitter.prototype);

  DOMBars.Parser = require('./parser');
  DOMBars.Parser.yy = DOMBars.AST;

  DOMBars.Compiler           = require('./compilers/base');
  DOMBars.JavaScriptCompiler = require('./compilers/javascript');

  /**
   * Check the arguments passed into the compilation functions before trying to
   * compile the as a program.
   *
   * @param  {Function} fn
   * @return {Function}
   */
  var compilePrecheck = function (fn) {
    return function (input, options) {
      if (typeof input !== 'string') {
        if (!(input instanceof DOMBars.AST.ProgramNode)) {
          throw new DOMBars.Exception(
            'You must pass a string or DOMBars AST to DOMBars.precompile. ' +
            'You passed ' + input
          );
        }
      }

      options = options || {};

      if (!('data' in options)) {
        options.data = true;
      }

      return fn(input, options);
    };
  };

  /**
   * Precompile generates a string-based JavaScript function.
   *
   * @param  {String} input
   * @param  {Object} options
   * @return {String}
   */
  DOMBars.precompile = compilePrecheck(function (input, options) {
    var ast         = DOMBars.parse(input);
    var environment = new DOMBars.Compiler().compile(ast, options);
    return new DOMBars.JavaScriptCompiler().compile(environment, options);
  });

  /**
   * Compilation return a function that is immediately ready for execution as a
   * template.
   *
   * @param  {String}   input
   * @param  {Object}   options
   * @return {Function}
   */
  DOMBars.compile = compilePrecheck(function (input, options) {
    var compiled;

    var compile = function () {
      var ast          = DOMBars.parse(input);
      var environment  = new DOMBars.Compiler().compile(ast, options);
      var templateSpec = new DOMBars.JavaScriptCompiler().compile(
        environment, options, undefined, true
      );

      return DOMBars.template(templateSpec);
    };

    return function (context, options) {
      if (!compiled) {
        compiled = compile();
      }

      return compiled.call(this, context, options);
    };
  });

  return DOMBars;
};
